apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-script
  namespace: ecom2micro-minimal
data:
  init-postgres-schemas.sql: |
    -- Create schemas for multi-tenant PostgreSQL
    CREATE SCHEMA IF NOT EXISTS identity_schema;
    CREATE SCHEMA IF NOT EXISTS catalog_schema;
    CREATE SCHEMA IF NOT EXISTS order_schema;

    -- Grant permissions
    GRANT ALL ON SCHEMA identity_schema TO postgres;
    GRANT ALL ON SCHEMA catalog_schema TO postgres;
    GRANT ALL ON SCHEMA order_schema TO postgres;

    -- Create extensions
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS pg_trgm;

    -- Set search path
    ALTER DATABASE ecom2micro SET search_path TO identity_schema, catalog_schema, order_schema, public;

    -- Function to show schema sizes
    CREATE OR REPLACE FUNCTION show_schema_sizes()
    RETURNS TABLE (
        schema_name TEXT,
        size_mb NUMERIC
    ) AS $$
    BEGIN
        RETURN QUERY
        SELECT 
            nspname::TEXT AS schema_name,
            ROUND(SUM(pg_total_relation_size(c.oid))::NUMERIC / (1024 * 1024), 2) AS size_mb
        FROM pg_class c
        JOIN pg_namespace n ON n.oid = c.relnamespace
        WHERE nspname IN ('identity_schema', 'catalog_schema', 'order_schema')
        GROUP BY nspname
        ORDER BY size_mb DESC;
    END;
    $$ LANGUAGE plpgsql;

    -- Identity Schema Tables
    SET search_path TO identity_schema;

    CREATE TABLE IF NOT EXISTS users (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        email VARCHAR(255) UNIQUE NOT NULL,
        username VARCHAR(100) UNIQUE NOT NULL,
        password_hash VARCHAR(255) NOT NULL,
        first_name VARCHAR(100),
        last_name VARCHAR(100),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS roles (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        name VARCHAR(50) UNIQUE NOT NULL,
        description TEXT
    );

    CREATE TABLE IF NOT EXISTS user_roles (
        user_id UUID REFERENCES users(id) ON DELETE CASCADE,
        role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
        PRIMARY KEY (user_id, role_id)
    );

    -- Catalog Schema Tables
    SET search_path TO catalog_schema;

    CREATE TABLE IF NOT EXISTS categories (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        name VARCHAR(100) NOT NULL,
        description TEXT,
        parent_id UUID REFERENCES categories(id),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS products (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        name VARCHAR(255) NOT NULL,
        description TEXT,
        price DECIMAL(10, 2) NOT NULL,
        stock_quantity INTEGER NOT NULL DEFAULT 0,
        category_id UUID REFERENCES categories(id),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE INDEX idx_products_category ON products(category_id);
    CREATE INDEX idx_products_name ON products USING gin(name gin_trgm_ops);

    -- Order Schema Tables (includes Cart and Payment)
    SET search_path TO order_schema;

    CREATE TABLE IF NOT EXISTS orders (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        user_id UUID NOT NULL,
        status VARCHAR(50) NOT NULL,
        total_amount DECIMAL(10, 2) NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS order_items (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
        product_id UUID NOT NULL,
        quantity INTEGER NOT NULL,
        price DECIMAL(10, 2) NOT NULL
    );

    CREATE TABLE IF NOT EXISTS carts (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        user_id UUID NOT NULL UNIQUE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS cart_items (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        cart_id UUID REFERENCES carts(id) ON DELETE CASCADE,
        product_id UUID NOT NULL,
        quantity INTEGER NOT NULL,
        added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS payments (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
        amount DECIMAL(10, 2) NOT NULL,
        status VARCHAR(50) NOT NULL,
        payment_method VARCHAR(50),
        transaction_id VARCHAR(255),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE INDEX idx_orders_user ON orders(user_id);
    CREATE INDEX idx_order_items_order ON order_items(order_id);
    CREATE INDEX idx_carts_user ON carts(user_id);
    CREATE INDEX idx_payments_order ON payments(order_id);

    -- Insert default roles
    SET search_path TO identity_schema;
    INSERT INTO roles (name, description) VALUES 
        ('Admin', 'Administrator with full access'),
        ('User', 'Regular user'),
        ('Guest', 'Guest user with limited access')
    ON CONFLICT (name) DO NOTHING;

    -- Reset search path
    SET search_path TO public;
